<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Menu Item</title>
    <link rel="stylesheet" type="text/css" href="styles/business_item_customization.css">
</head>

<body>
    <iframe src="HeaderMenu.html" class="header-frame"></iframe>

    <div class="container">
        <h1><input type="text" id="item-name" value="Loading..."></h1>
        <img id="item-image" src="" alt="Item Image">
        <p>Price: $<input type="number" id="item-price" step="0.01"></p>

        <div class="item-section">
            <h2>Included Items</h2>
            <div id="free-items"></div>
        </div>

        <div class="item-section">
            <h2>Free Toggle Items</h2>
            <div id="free-toggle-items"></div>
        </div>

        <div class="item-section">
            <h2>Paid Extras</h2>
            <div id="paid-items"></div>
        </div>

        <div class="item-section">
            <h2>Paid Toggle Extras</h2>
            <div id="paid-toggle-items"></div>
        </div>

        <button onclick="updateItem()">Update Item</button>
    </div>

    <script>

        async function fetchItemDetails(itemID) {
            try {
                const response = await fetch(`http://127.0.0.1:5000/get-item?itemID=${itemID}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const item = await response.json();

                if (!item || Object.keys(item).length === 0) {
                    alert("Item not found.");
                    return;
                }

                document.getElementById("item-name").value = item.itemName;
                document.getElementById("item-price").value = item.price.toFixed(2);
                document.getElementById("item-image").src = item.itemImageUrl || "default-image.jpg";

                populateItems("free-items", item.freeItems, true);
                populateToggleItems("free-toggle-items", item.freeToggleItems, true);
                populateItems("paid-items", item.paidItems, false);
                populateToggleItems("paid-toggle-items", item.paidToggleItems, false);

            } catch (error) {
                console.error("Error fetching item details:", error);
                alert("Failed to load item details.");
            }
        }

        function populateItems(containerId, items, isFree) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            if (items) {
                Object.entries(items).forEach(([name, included]) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                        <label>${name}: </label>
                        <input type="checkbox" ${included ? "checked" : ""} data-name="${name}">
                    `;
                    container.appendChild(div);
                });
            }
        }

        function populateToggleItems(containerId, toggleItems, isFree) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            (toggleItems || []).forEach(toggle => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <label>${toggle.name} (${toggle.type}): </label>
                    <input type="checkbox" ${toggle.selected ? "checked" : ""} data-name="${toggle.name}" data-type="${toggle.type}">
                    ${isFree ? "" : `<input type="number" value="${toggle.price.toFixed(2)}" step="0.01">`}
                `;
                container.appendChild(div);
            });
        }


        async function updateItem() {
            const params = new URLSearchParams(window.location.search);
            const itemID = params.get("itemID");  

            if (!itemID) {                     
                alert("Invalid Item ID.");
                return;
            }

            const updatedData = {
                itemName: document.getElementById("item-name").value,
                price: parseFloat(document.getElementById("item-price").value),
                freeItems: getUpdatedItems("free-items"),
                freeToggleItems: getUpdatedToggleItems("free-toggle-items"),
                paidItems: getUpdatedItems("paid-items"),
                paidToggleItems: getUpdatedToggleItems("paid-toggle-items")
            };

            try {
                const res = await fetch("http://127.0.0.1:5000/update-item", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        itemID: itemID,          
                        update_fields: updatedData
                    })
                });
                alert((await res.json()).message);
            } catch (err) {
                console.error("Update failed:", err);
                alert("Failed to update item.");
            }
        }

       

        function getUpdatedItems(containerId) {
            const items = {};
            document.getElementById(containerId).querySelectorAll("input[type='checkbox']").forEach(input => {
                items[input.getAttribute("data-name")] = input.checked;
            });
            return items;
        }

        function getUpdatedToggleItems(containerId) {
            const toggleItems = [];
            document.getElementById(containerId).querySelectorAll("div").forEach(div => {
                const name = div.querySelector("input[type='checkbox']").getAttribute("data-name");
                const type = div.querySelector("input[type='checkbox']").getAttribute("data-type");
                const selected = div.querySelector("input[type='checkbox']").checked;
                const priceInput = div.querySelector("input[type='number']");
                const price = priceInput ? parseFloat(priceInput.value) : 0;

                toggleItems.push({ name, type, selected, price });
            });
            return toggleItems;
        }

     

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const itemID = params.get("itemID");  
            if (itemID) fetchItemDetails(itemID);
            else alert("Invalid Item ID.");
        };

    </script>
</body>

</html>